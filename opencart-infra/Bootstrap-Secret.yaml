apiVersion: v1
kind: Secret
metadata:
  name: oc-mysql-bootstrap-secret
  labels:
    vm-selector: oc-mysql
stringData:
  user-data: |
    #cloud-config
    package_update: true
    package_upgrade: all
    
    packages:
      - mysql-server
      - mysql-client-core-8.0
      - unzip
      - open-vm-tools
    
    users:
      - name: demouser
        sudo: ['ALL=(ALL) NOPASSWD:ALL']
        groups: sudo
        shell: /bin/bash
        lock_passwd: false
        passwd: VMware1!
        ssh_authorized_keys:
          - ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEAyCdobTWPsYBjDRTcUYO/6LF8wwkVAlU8Jm1KcB9FV+qbjmazGH0JV156LnwerqU59ehc9CSSCFRciSyq/04lHoD3erXqzloBEBxnynq7aWHVotB39ODRSTvjqraGh2+MfIeatTeAtRB7k6LLhcT9ADdAMQIR236W9iHxAX9rJVHwtdtDQNckdFSSdlgnH1FcZvlsAPelmBe/tNYVm091/vJZEqfKR80QKDc7Dmah7NJImWPuQXtsPAecOX/iEMVJJDeHnAI1zyJ7Mvqfph3Tp5qIcLgQ/UadSt18dHUyXaYuOXDzbVJX3/EBkV+FAymjklbTFVz965niGyaEw1aW+Q== rsa-key-20220728
            ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDiJTwfjUdYsqeawEOYVhr10EvBpReDrujN77XhNCbR783agr4RmXpA3wKaDv5tqzIcKeLYFG9ihLH7SM5AzZsczneI6aNSN2MC37I4f+Xivpc0Awak2XlQqQhUUSdYzi31vUko6KEi1cHa/W3/OuPZsCpPpSw6fu4Xxmw7RoP6P95JtN+XK6Z9Ic1qG9UWLqef2GxYNcx+zchVqLYuNgE7/3JZs9T2sqUKxHBK2ODg+E/kQk+3U1uY5s+pfYZF+mqZJczSxJf4iCVPJm3b4iidzm+K5NNv+4VOg7sBJxmDVS+1l0Ufwo49E2peJP/Zq6UtUO09oLhDNBRSRBNjOwbj7+9kyUQDTLttKa1DYuT1wWFk9+YHHGXcAZwjwj6tJFf+6a5ZVuXry5ntbxdbuNuV9YMRkSVrarJVfKgAuMDBniZKie5ZPFgaID+ndlOZ5WBL00dHzM5L8erg/WiD7W4UhQwbX7ZnSgE8svITGzt9kvWMTRn+lVgFN9QSga5gMQsoT3TyQGiHaTxh5mRx7oSJKThKzi9fP/QKx1IO4BOXkrOi/jeagWrSNcQvg3iPW8hNVeW4ndM8OT7ojgTTUdRhJSVxXbCJyksmiPfS6cNWcgoJccuSWC+uIVh4qsvoB9w9J7BrYXjwtnhs50g5jGowlZYz6uNAkpW1oqrgfoKmAw== ubuntu@ubuntuguest
      - name: ocuser
        sudo: ['ALL=(ALL) NOPASSWD:ALL']
        groups: sudo
        shell: /bin/bash
    
    write_files:
      # Permanent DNS via Netplan
      - path: /etc/netplan/01-netcfg-dns.yaml
        content: |
          network:
            version: 2
            ethernets:
              eth0:
                nameservers:
                  addresses:
                    - 8.8.8.8
      # Cron job for opencart cleanup
      - path: /etc/cron.hourly/oc_cleanup
        owner: root
        permissions: '0777'
        content: |
          #!/bin/bash
          mysql -uroot -proot -e "USE opencart; CREATE TABLE oc_session_copy LIKE oc_session; DROP TABLE oc_session; RENAME TABLE oc_session_copy TO oc_session;"
      # Hosts entry for oc-mysql
      - path: /etc/hosts
        content: |
          127.0.0.1 oc-mysql
        append: true
    
    runcmd:
      - export DEBIAN_FRONTEND=noninteractive
      - USER=ocuser
      - PASS=VMware1!
      - hostnamectl set-hostname mysql
      # Apply netplan so DNS works immediately
      - netplan apply
      # Ensure MySQL service is enabled and started
      - systemctl enable mysql
      - systemctl start mysql
      - sleep 5
      # Confirm mysql client exists
      - mysql --version
      # Switch root to password auth
      - mysql -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'root';"
      # Allow remote access
      - sed -i 's/^bind-address/#bind-address/' /etc/mysql/mysql.conf.d/mysqld.cnf
      - systemctl restart mysql
      # Create application user and grant permissions
      - mysql -uroot -proot -e "CREATE USER IF NOT EXISTS '$USER'@'%' IDENTIFIED BY '$PASS'; GRANT ALL PRIVILEGES ON *.* TO '$USER'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;"
      # Create application database
      - mysql -uroot -proot -e "CREATE DATABASE IF NOT EXISTS opencart;"
      - echo 'Cloud-init is done!' >> /tmp/finished.txt
