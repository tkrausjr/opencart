apiVersion: v1
kind: Secret
metadata:
  name: oc-mysql-bootstrap-secret
  labels:
    vm-selector: oc-mysql
stringData:
  user-data: |
    #cloud-config
    package_update: true
    package_upgrade: all
    
    packages:
      - mysql-server
      - mysql-client-core-8.0
      - unzip
      - open-vm-tools
    
    users:
      - name: demouser
        sudo: ['ALL=(ALL) NOPASSWD:ALL']
        groups: sudo
        shell: /bin/bash
        lock_passwd: false
        passwd: "$6$JdcIivnEYo./eO7.$B5vcmBo.w/uWH43aqQV3jIF24lLFvUBEJKJ9my3QSx8j8k.huionmqTtW1gAWrSF23LlLcmdudDET3Au5JKFe0"
        ssh_authorized_keys:
          - ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEAyCdobTWPsYBjDRTcUYO/6LF8wwkVAlU8Jm1KcB9FV+qbjmazGH0JV156LnwerqU59ehc9CSSCFRciSyq/04lHoD3erXqzloBEBxnynq7aWHVotB39ODRSTvjqraGh2+MfIeatTeAtRB7k6LLhcT9ADdAMQIR236W9iHxAX9rJVHwtdtDQNckdFSSdlgnH1FcZvlsAPelmBe/tNYVm091/vJZEqfKR80QKDc7Dmah7NJImWPuQXtsPAecOX/iEMVJJDeHnAI1zyJ7Mvqfph3Tp5qIcLgQ/UadSt18dHUyXaYuOXDzbVJX3/EBkV+FAymjklbTFVz965niGyaEw1aW+Q== rsa-key-20220728
      - name: ocuser
        sudo: ['ALL=(ALL) NOPASSWD:ALL']
        groups: sudo
        lock_passwd: false
        passwd: "$6$JdcIivnEYo./eO7.$B5vcmBo.w/uWH43aqQV3jIF24lLFvUBEJKJ9my3QSx8j8k.huionmqTtW1gAWrSF23LlLcmdudDET3Au5JKFe0"
        shell: /bin/bash
    
    write_files:
      # Password Authentication via SSH
      - path: /etc/ssh/sshd_config.d/60-cloudimg-settings.conf
        content: |
          PasswordAuthentication yes
          AllowUsers demouser ocuser
      # Permanent DNS via Netplan
      - path: /etc/netplan/01-netcfg-dns.yaml
        content: |
          network:
            version: 2
            ethernets:
              eth0:
                mtu: 1500
                nameservers:
                  addresses:
                    - 10.1.1.1
                    - 8.8.8.8
      # Make sure MTU is set last and correctly
      - path: /etc/netplan/99-custom-mtu-netcfg.yaml
        content: |
          network:
            version: 2
            ethernets:
              eth0:
                mtu: 1500
      # Cron job for opencart cleanup
      - path: /etc/cron.hourly/oc_cleanup
        owner: root
        permissions: '0777'
        content: |
          #!/bin/bash
          mysql -uroot -proot -e "USE opencart; CREATE TABLE oc_session_copy LIKE oc_session; DROP TABLE oc_session; RENAME TABLE oc_session_copy TO oc_session;"
      # Hosts entry for oc-mysql
      - path: /etc/hosts
        content: |
          127.0.0.1 oc-mysql
        append: true
    
    runcmd:
      - export DEBIAN_FRONTEND=noninteractive
      - USER=ocuser
      - PASS=VMware1!
      - hostnamectl set-hostname mysql
      # Apply netplan so DNS works immediately
      - netplan apply
      # Ensure MySQL service is enabled and started
      - systemctl enable mysql
      - systemctl start mysql
      - sleep 5
      # Confirm mysql client exists
      - mysql --version
      # Switch root to password auth
      - mysql -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'root';"
      # Allow remote access
      - sed -i 's/^bind-address/#bind-address/' /etc/mysql/mysql.conf.d/mysqld.cnf
      - systemctl restart mysql
      # Create application user and grant permissions
      - mysql -uroot -proot -e "CREATE USER IF NOT EXISTS '$USER'@'%' IDENTIFIED BY '$PASS'; GRANT ALL PRIVILEGES ON *.* TO '$USER'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;"
      # Create application database
      - mysql -uroot -proot -e "CREATE DATABASE IF NOT EXISTS opencart;"
      - echo 'Cloud-init is done!' >> /tmp/finished.txt
